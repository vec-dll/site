<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Завдання, Нотатки та Фото</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #0a1f0a, #228b22); /* Градієнт зелених тонів */
            color: #32cd32; /* Кислотно-зелений текст */
            animation: backgroundPulse 5s infinite alternate;
        }
        @keyframes backgroundPulse {
            0% { background-color: #0a1f0a; }
            100% { background-color: #006400; }
        }
        .container {
            margin-top: 50px;
            animation: fadeInContainer 1s ease-in-out;
        }
        @keyframes fadeInContainer {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .nav-tabs .nav-link {
            color: #32cd32;
            border-color: #006400;
            transition: color 0.3s, transform 0.3s;
        }
        .nav-tabs .nav-link:hover {
            color: #ffffff;
            transform: scale(1.1);
        }
        .nav-tabs .nav-link.active {
            background-color: #006400;
            border-color: #006400 #006400 #006400;
            color: #ffffff;
            animation: tabActive 0.5s;
        }
        @keyframes tabActive {
            0% { transform: scale(0.9); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        .tab-content {
            padding: 20px;
            background: linear-gradient(to bottom, #006400, #228b22);
            border: 1px solid #0a1f0a;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,255,0,0.2);
            animation: contentGlow 2s infinite alternate;
        }
        @keyframes contentGlow {
            0% { box-shadow: 0 4px 8px rgba(0,255,0,0.2); }
            100% { box-shadow: 0 4px 12px rgba(0,255,0,0.5); }
        }
        .list-group-item {
            background-color: #228b22;
            color: #32cd32;
            border-color: #0a1f0a;
            transition: transform 0.3s ease, opacity 0.5s ease-in-out, background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .list-group-item:hover {
            transform: translateY(-5px) rotate(1deg);
            box-shadow: 0 2px 4px rgba(0,255,0,0.1);
            background-color: #32cd32;
            color: #0a1f0a;
        }
        .list-group-item.completed {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .fade-in {
            opacity: 0;
            transform: translateY(20px) scale(0.9);
            animation: fadeInItem 0.5s forwards;
        }
        @keyframes fadeInItem {
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .img-thumbnail {
            max-width: 200px;
            margin: 10px;
            border: 2px solid #32cd32;
            border-radius: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease, filter 0.3s;
            animation: photoPop 0.5s;
        }
        @keyframes photoPop {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        .img-thumbnail:hover {
            transform: scale(1.1) rotate(3deg);
            box-shadow: 0 4px 8px rgba(0,255,0,0.3);
            filter: brightness(1.2);
        }
        .form-control {
            background-color: #228b22;
            color: #32cd32;
            border-color: #0a1f0a;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-control:focus {
            border-color: #32cd32;
            box-shadow: 0 0 8px rgba(50,205,50,0.5);
        }
        .form-control::placeholder {
            color: #90ee90;
        }
        .btn-success {
            background-color: #32cd32;
            border-color: #32cd32;
            transition: background-color 0.3s ease, transform 0.3s;
        }
        .btn-success:hover {
            background-color: #228b22;
            transform: scale(1.05);
        }
        .btn-danger {
            background-color: #ff4500;
            border-color: #ff4500;
            transition: background-color 0.3s, transform 0.3s;
        }
        .btn-danger:hover {
            background-color: #cc3700;
            transform: scale(1.05);
        }
        .btn-primary {
            background-color: #32cd32;
            border-color: #32cd32;
        }
        h1, h3 {
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,255,0,0.5);
            animation: textGlow 1.5s infinite alternate;
        }
        @keyframes textGlow {
            0% { text-shadow: 1px 1px 2px rgba(0,255,0,0.5); }
            100% { text-shadow: 1px 1px 4px rgba(0,255,0,0.8); }
        }
        .task-time {
            font-size: 0.8em;
            color: #90ee90;
            margin-left: 10px;
            flex-grow: 1;
        }
        #photos-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background-color: rgba(0,100,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: galleryFade 1s;
        }
        @keyframes galleryFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .photo-item {
            position: relative;
            margin: 10px;
        }
        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255,69,0,0.8);
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: opacity 0.3s;
            opacity: 0;
        }
        .photo-item:hover .photo-delete {
            opacity: 1;
        }
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
    <script src="https://unpkg.com/@octokit/rest@20.1.1/dist/octokit.rest.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="header">
            <h1 class="mb-0">Завдання, Нотатки та Фото</h1>
            <button class="btn btn-primary" data-toggle="modal" data-target="#authModal" id="login-btn">Вхід в GitHub</button>
        </div>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="tasks-tab" data-toggle="tab" href="#tasks" role="tab">Завдання</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="notes-tab" data-toggle="tab" href="#notes" role="tab">Нотатки</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="photos-tab" data-toggle="tab" href="#photos" role="tab">Фото</a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="tasks" role="tabpanel">
                <h3>Завдання</h3>
                <ul class="list-group" id="tasks-list"></ul>
                <div class="form-group mt-3">
                    <input type="text" class="form-control" id="new-task" placeholder="Нове завдання">
                    <button class="btn btn-success mt-2" onclick="addTask()">Додати</button>
                </div>
            </div>
            <div class="tab-pane fade" id="notes" role="tabpanel">
                <h3>Нотатки</h3>
                <ul class="list-group" id="notes-list"></ul>
                <div class="form-group mt-3">
                    <input type="text" class="form-control" id="new-note" placeholder="Нова нотатка">
                    <button class="btn btn-success mt-2" onclick="addNote()">Додати</button>
                </div>
            </div>
            <div class="tab-pane fade" id="photos" role="tabpanel">
                <h3>Фото</h3>
                <div id="photos-gallery"></div>
                <div class="form-group mt-3" id="upload-form" style="display: none;">
                    <input type="file" class="form-control-file" id="new-photo" accept="image/*">
                    <button class="btn btn-success mt-2" onclick="addPhoto()">Завантажити</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for GitHub Auth -->
    <div class="modal fade" id="authModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: linear-gradient(to bottom, #006400, #228b22); color: #32cd32;">
                <div class="modal-header">
                    <h5 class="modal-title">Підключення до GitHub</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Введіть дані для перегляду/редагування фото. Репозиторій повинен бути публічним для загального доступу.</p>
                    <div class="form-group">
                        <label for="owner">Власник репозиторію (username):</label>
                        <input type="text" class="form-control" id="owner" placeholder="yourusername">
                    </div>
                    <div class="form-group">
                        <label for="repo">Назва репозиторію:</label>
                        <input type="text" class="form-control" id="repo" placeholder="your-repo-name">
                    </div>
                    <div class="form-group">
                        <label for="token">GitHub Personal Access Token (для редагування):</label>
                        <input type="password" class="form-control" id="token" placeholder="ghp_...">
                    </div>
                    <div class="form-group">
                        <label for="branch">Гілка (за замовчуванням main):</label>
                        <input type="text" class="form-control" id="branch" value="main">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрити</button>
                    <button type="button" class="btn btn-success" onclick="connectToGitHub()">Підключитися</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let owner = localStorage.getItem('github_owner') || '';
        let repo = localStorage.getItem('github_repo') || '';
        let branch = localStorage.getItem('github_branch') || 'main';
        let token = '';
        let octokit;
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let photos = [];
        let isAuth = false;
        let isRepoSet = !!owner && !!repo;

        function connectToGitHub() {
            owner = document.getElementById('owner').value;
            repo = document.getElementById('repo').value;
            token = document.getElementById('token').value;
            branch = document.getElementById('branch').value;

            if (!owner || !repo || !branch) {
                alert('Заповніть обов\'язкові поля!');
                return;
            }

            localStorage.setItem('github_owner', owner);
            localStorage.setItem('github_repo', repo);
            localStorage.setItem('github_branch', branch);
            isRepoSet = true;

            if (token) {
                octokit = new Octokit({ auth: token });
                isAuth = true;
                document.getElementById('upload-form').style.display = 'block';
            } else {
                isAuth = false;
                document.getElementById('upload-form').style.display = 'none';
            }

            $('#authModal').modal('hide');
            loadPhotos();
        }

        async function loadData() {
            displayTasks();
            displayNotes();
            if (isRepoSet) {
                await loadPhotos();
            } else {
                document.getElementById('photos-gallery').innerHTML = '<p>Налаштуйте GitHub для перегляду фото (кнопка "Вхід в GitHub").</p>';
            }
        }

        async function loadPhotos() {
            photos = await loadJson('data/photos.json') || { photos: [] };
            photos = photos.photos || [];
            displayPhotos();
        }

        async function loadJson(path) {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`);
                if (!response.ok) throw new Error();
                return await response.json();
            } catch (e) {
                console.log(`File ${path} not found, assuming empty.`);
                return { photos: [] };
            }
        }

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days} днів тому`;
            if (hours > 0) return `${hours} годин тому`;
            if (minutes > 0) return `${minutes} хвилин тому`;
            return `${seconds} секунд тому`;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            let str = '';
            if (days > 0) str += `${days} днів `;
            if (hours % 24 > 0) str += `${hours % 24} годин `;
            if (minutes % 60 > 0) str += `${minutes % 60} хвилин `;
            if (seconds % 60 > 0) str += `${seconds % 60} секунд`;
            return str.trim() || '0 секунд';
        }

        function displayTasks() {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.classList.add('list-group-item', 'fade-in');
                if (task.completed) li.classList.add('completed');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.completed;
                checkbox.onchange = () => toggleTaskCompleted(index);

                const textSpan = document.createElement('span');
                textSpan.textContent = task.text;

                const timeSpan = document.createElement('span');
                timeSpan.classList.add('task-time');
                if (task.completed && task.completedTime) {
                    const duration = task.completedTime - task.created;
                    timeSpan.textContent = `Виконано за ${formatDuration(duration)}`;
                } else {
                    timeSpan.textContent = `Висять ${formatTimeAgo(task.created)}`;
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm');
                deleteBtn.textContent = 'Видалити';
                deleteBtn.onclick = () => removeTask(index);

                li.appendChild(checkbox);
                li.appendChild(textSpan);
                li.appendChild(timeSpan);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
        }

        function displayNotes() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';
            notes.forEach((note, index) => {
                const li = document.createElement('li');
                li.classList.add('list-group-item', 'fade-in');

                const textSpan = document.createElement('span');
                textSpan.textContent = note.text;

                const timeSpan = document.createElement('span');
                timeSpan.classList.add('task-time');
                timeSpan.textContent = formatTimeAgo(note.created);

                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm');
                deleteBtn.textContent = 'Видалити';
                deleteBtn.onclick = () => removeNote(index);

                li.appendChild(textSpan);
                li.appendChild(timeSpan);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
        }

        function displayPhotos() {
            const gallery = document.getElementById('photos-gallery');
            gallery.innerHTML = '';
            gallery.classList.add('d-flex', 'flex-wrap');
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.classList.add('photo-item');

                const img = document.createElement('img');
                img.src = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/images/${photo}`;
                img.classList.add('img-thumbnail');

                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('photo-delete');
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = () => removePhoto(index);
                if (!isAuth) deleteBtn.style.display = 'none';

                div.appendChild(img);
                div.appendChild(deleteBtn);
                gallery.appendChild(div);
            });
            document.getElementById('upload-form').style.display = isAuth ? 'block' : 'none';
        }

        function addTask() {
            const newTaskText = document.getElementById('new-task').value;
            if (!newTaskText) return;

            const newTask = { text: newTaskText, created: Date.now(), completed: false, completedTime: null };
            tasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            document.getElementById('new-task').value = '';
            displayTasks();
        }

        function toggleTaskCompleted(index) {
            tasks[index].completed = !tasks[index].completed;
            if (tasks[index].completed && !tasks[index].completedTime) {
                tasks[index].completedTime = Date.now();
            } else if (!tasks[index].completed) {
                tasks[index].completedTime = null;
            }
            localStorage.setItem('tasks', JSON.stringify(tasks));
            displayTasks();
        }

        function removeTask(index) {
            tasks.splice(index, 1);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            displayTasks();
        }

        function addNote() {
            const newNoteText = document.getElementById('new-note').value;
            if (!newNoteText) return;

            const newNote = { text: newNoteText, created: Date.now() };
            notes.push(newNote);
            localStorage.setItem('notes', JSON.stringify(notes));
            document.getElementById('new-note').value = '';
            displayNotes();
        }

        function removeNote(index) {
            notes.splice(index, 1);
            localStorage.setItem('notes', JSON.stringify(notes));
            displayNotes();
        }

        async function addPhoto() {
            if (!isAuth) {
                alert('Потрібна авторизація для завантаження!');
                return;
            }
            const fileInput = document.getElementById('new-photo');
            const file = fileInput.files[0];
            if (!file) {
                alert('Спочатку оберіть фото!');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result.split(',')[1];
                const filename = Date.now() + '_' + file.name.replace(/\s/g, '_');
                const path = 'images/' + filename;

                await uploadFile(path, base64, 'Upload new photo');

                photos.push(filename);
                await updateJson('data/photos.json', { photos });

                displayPhotos();
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        async function removePhoto(index) {
            if (!isAuth) {
                alert('Потрібна авторизація для видалення!');
                return;
            }
            const filename = photos[index];
            const path = 'images/' + filename;

            const sha = await getFileSha(path);
            if (sha) {
                await octokit.repos.deleteFile({
                    owner,
                    repo,
                    path,
                    message: 'Delete photo',
                    sha,
                    branch
                });
            }

            photos.splice(index, 1);
            await updateJson('data/photos.json', { photos });

            displayPhotos();
        }

        async function updateJson(path, data) {
            const newContent = JSON.stringify(data, null, 2);
            const base64Content = btoa(unescape(encodeURIComponent(newContent)));
            const sha = await getFileSha(path);
            await octokit.repos.createOrUpdateFileContents({
                owner,
                repo,
                path,
                message: 'Update photos',
                content: base64Content,
                sha,
                branch
            });
        }

        async function uploadFile(path, base64Content, message) {
            const sha = await getFileSha(path);
            await octokit.repos.createOrUpdateFileContents({
                owner,
                repo,
                path,
                message,
                content: base64Content,
                sha,
                branch
            });
        }

        async function getFileSha(path) {
            try {
                const response = await octokit.repos.getContent({
                    owner,
                    repo,
                    path,
                    ref: branch
                });
                return response.data.sha;
            } catch (e) {
                if (e.status === 404) {
                    return undefined;
                }
                throw e;
            }
        }

        // Listen for tab shown event
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (e.target.id === 'photos-tab' && !isRepoSet) {
                $('#authModal').modal('show');
            }
        });

        // Load data on start
        loadData();

        // Pre-fill form with saved values
        document.getElementById('owner').value = owner;
        document.getElementById('repo').value = repo;
        document.getElementById('branch').value = branch;
    </script>
</body>
</html>
