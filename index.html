<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Завдання, Нотатки та Фото</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 50px;
        }
        .tab-content {
            padding: 20px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .list-group-item {
            transition: opacity 0.5s ease-in-out;
        }
        .fade-in {
            opacity: 0;
        }
        .fade-in.active {
            opacity: 1;
        }
        .img-thumbnail {
            max-width: 200px;
            margin: 10px;
            transition: transform 0.3s ease;
        }
        .img-thumbnail:hover {
            transform: scale(1.05);
        }
        #auth-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://unpkg.com/@octokit/rest@20.1.1/dist/octokit.rest.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="auth-form">
            <h2 class="text-center">Підключення до GitHub</h2>
            <p>Введіть дані для доступу до репозиторію. Токен повинен мати права на читання/запис контенту (scopes: repo або public_repo).</p>
            <div class="form-group">
                <label for="owner">Власник репозиторію (username):</label>
                <input type="text" class="form-control" id="owner" placeholder="yourusername">
            </div>
            <div class="form-group">
                <label for="repo">Назва репозиторію:</label>
                <input type="text" class="form-control" id="repo" placeholder="your-repo-name">
            </div>
            <div class="form-group">
                <label for="token">GitHub Personal Access Token:</label>
                <input type="password" class="form-control" id="token" placeholder="ghp_...">
            </div>
            <div class="form-group">
                <label for="branch">Гілка (за замовчуванням main):</label>
                <input type="text" class="form-control" id="branch" value="main">
            </div>
            <button class="btn btn-primary btn-block" onclick="connectToGitHub()">Підключитися</button>
        </div>

        <div id="main-content" class="hidden">
            <h1 class="text-center mb-4">Завдання, Нотатки та Фото</h1>
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="tasks-tab" data-toggle="tab" href="#tasks" role="tab">Завдання</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="notes-tab" data-toggle="tab" href="#notes" role="tab">Нотатки</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="photos-tab" data-toggle="tab" href="#photos" role="tab">Фото</a>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="tasks" role="tabpanel">
                    <h3>Завдання</h3>
                    <ul class="list-group" id="tasks-list"></ul>
                    <div class="form-group mt-3">
                        <input type="text" class="form-control" id="new-task" placeholder="Нове завдання">
                        <button class="btn btn-success mt-2" onclick="addTask()">Додати</button>
                    </div>
                </div>
                <div class="tab-pane fade" id="notes" role="tabpanel">
                    <h3>Нотатки</h3>
                    <ul class="list-group" id="notes-list"></ul>
                    <div class="form-group mt-3">
                        <input type="text" class="form-control" id="new-note" placeholder="Нова нотатка">
                        <button class="btn btn-success mt-2" onclick="addNote()">Додати</button>
                    </div>
                </div>
                <div class="tab-pane fade" id="photos" role="tabpanel">
                    <h3>Фото</h3>
                    <div id="photos-gallery" class="d-flex flex-wrap"></div>
                    <div class="form-group mt-3">
                        <input type="file" class="form-control-file" id="new-photo" accept="image/*">
                        <button class="btn btn-success mt-2" onclick="addPhoto()">Завантажити</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let owner, repo, token, branch, octokit;
        let tasks = [], notes = [], photos = [];

        function connectToGitHub() {
            owner = document.getElementById('owner').value;
            repo = document.getElementById('repo').value;
            token = document.getElementById('token').value;
            branch = document.getElementById('branch').value;

            if (!owner || !repo || !token || !branch) {
                alert('Заповніть всі поля!');
                return;
            }

            octokit = new Octokit({ auth: token });

            document.getElementById('auth-form').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            loadData();
        }

        async function loadData() {
            tasks = await loadJson('data/tasks.json') || { tasks: [] };
            tasks = tasks.tasks || [];
            displayTasks();

            notes = await loadJson('data/notes.json') || { notes: [] };
            notes = notes.notes || [];
            displayNotes();

            photos = await loadJson('data/photos.json') || { photos: [] };
            photos = photos.photos || [];
            displayPhotos();
        }

        async function loadJson(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error();
                return await response.json();
            } catch (e) {
                console.log(`File ${path} not found, assuming empty.`);
                return { items: [] };
            }
        }

        function displayTasks() {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.classList.add('list-group-item');
                li.textContent = task;
                list.appendChild(li);
            });
        }

        function displayNotes() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';
            notes.forEach(note => {
                const li = document.createElement('li');
                li.classList.add('list-group-item');
                li.textContent = note;
                list.appendChild(li);
            });
        }

        function displayPhotos() {
            const gallery = document.getElementById('photos-gallery');
            gallery.innerHTML = '';
            photos.forEach(photo => {
                const img = document.createElement('img');
                img.src = `images/${photo}`;
                img.classList.add('img-thumbnail');
                gallery.appendChild(img);
            });
        }

        async function addTask() {
            const newTask = document.getElementById('new-task').value;
            if (!newTask) return;

            tasks.push(newTask);
            await updateJson('data/tasks.json', { tasks });
            document.getElementById('new-task').value = '';

            const list = document.getElementById('tasks-list');
            const li = document.createElement('li');
            li.classList.add('list-group-item', 'fade-in');
            li.textContent = newTask;
            list.appendChild(li);
            setTimeout(() => li.classList.add('active'), 10);
        }

        async function addNote() {
            const newNote = document.getElementById('new-note').value;
            if (!newNote) return;

            notes.push(newNote);
            await updateJson('data/notes.json', { notes });
            document.getElementById('new-note').value = '';

            const list = document.getElementById('notes-list');
            const li = document.createElement('li');
            li.classList.add('list-group-item', 'fade-in');
            li.textContent = newNote;
            list.appendChild(li);
            setTimeout(() => li.classList.add('active'), 10);
        }

        async function addPhoto() {
            const fileInput = document.getElementById('new-photo');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result.split(',')[1];
                const filename = Date.now() + '_' + file.name.replace(/\s/g, '_');
                const path = 'images/' + filename;

                // Upload image
                await uploadFile(path, base64, 'Upload new photo');

                // Update photos.json
                photos.push(filename);
                await updateJson('data/photos.json', { photos });

                // Display new photo with animation
                const gallery = document.getElementById('photos-gallery');
                const img = document.createElement('img');
                img.src = `images/${filename}`;
                img.classList.add('img-thumbnail', 'fade-in');
                gallery.appendChild(img);
                setTimeout(() => img.classList.add('active'), 10);

                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        async function updateJson(path, data) {
            const newContent = JSON.stringify(data, null, 2);
            const base64Content = btoa(unescape(encodeURIComponent(newContent)));
            const sha = await getFileSha(path);
            await octokit.repos.createOrUpdateFileContents({
                owner,
                repo,
                path,
                message: 'Update data',
                content: base64Content,
                sha,
                branch
            });
        }

        async function uploadFile(path, base64Content, message) {
            const sha = await getFileSha(path);
            await octokit.repos.createOrUpdateFileContents({
                owner,
                repo,
                path,
                message,
                content: base64Content,
                sha,
                branch
            });
        }

        async function getFileSha(path) {
            try {
                const response = await octokit.repos.getContent({
                    owner,
                    repo,
                    path,
                    branch
                });
                return response.data.sha;
            } catch (e) {
                if (e.status === 404) {
                    return undefined;
                }
                throw e;
            }
        }
    </script>
</body>
</html>
